<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!--CSS-->
	<link rel="stylesheet" href="../resources/css/style.css">
	<link rel="stylesheet" href="../resources/css/carrito.css">
	<link rel="stylesheet" href="../resources/css/index.css">
	<title>Carrito</title>
</head>
<body>
    <header>
        <div class="container-header">
            <div>
                <h1><a href="/api/productos">Drink in the House</a></h1>
            </div>
            <div class="container-listas">
				<ul class="box-listas">
					<li class="listas"><a href="/api/carrito">carrito</a></li>
                    <li class="listas" style="margin-bottom: 5px;"><a href="/api/historial">Historial</a></li >
                    <li class="listas"><a href="/api/carrito" id="cart"><img src="./img/iconos/shopping-cart.png" alt=""><span id="cuenta-carrito">0</span></a></li>
                </ul>
            </div>
        </div>
    </header>

	<main>
		<section class="carrito">
			<p id="carrito-vacio">Che pibe, no hay productos en el carrito, raja de aca y <a href="./productos.html">elegi algunos productos</a> </p>
			<section id="cart-container">
			</section>

			<section id="totales">
				<div class="informacion">
					<p>Total unidades: </p><span id="cantidad">0</span>
				</div>
				<div class="informacion">
					<p>Total precio: </p> <p class="signo">$</p><span id="precio">0</span>
				</div>
				<p class="impuestos">Los impuestos de venta se calcularán durante el pago (si es aplicable)</p>
				<div class="botones">
					<button id="boton-pagar">Comprar</button>
					<button id="reiniciar">Vaciar Carrito</button>
				</div>
			</section>
		</section>
	</main>

	<footer>
		<p>Todos los derechos reservados :V</p>
	</footer>

	<script>
		const bebidas = [
  {
      "id": "1",
      "nombre_producto": "Whisky Johnnie Walker Black Label",
      "tipo": "alcohólicas",
      "volumen": "750ml",
      "valor": 12000,
      "cantidad": 50,
      "promocion": "10% off en compra de 2 o más",
      "image": "https://jumboargentina.vtexassets.com/arquivos/ids/791032-800-600?v=638283369754270000&width=800&height=600&aspect=true",
      "categoria": "whiskys"
  },
  {
      "id": "2",
      "nombre_producto": "Vino Malbec Catena Zapata",
      "tipo": "alcohólicas",
      "volumen": "750ml",
      "valor": 6500,
      "cantidad": 120,
      "promocion": "15% off en segunda unidad",
      "image": "https://www.vinosyspirits.com/media/catalog/product/6/5/65389.png?optimize=low&bg-color=255,255,255&fit=bounds&height=&width=&canvas=:",
      "categoria": "vinos"
  },
  {
      "id": "3",
      "nombre_producto": "Cerveza Corona Extra",
      "tipo": "alcohólicas",
      "volumen": "355ml",
      "valor": 350,
      "cantidad": 300,
      "promocion": "Compra 12 y paga 10",
      "image": "https://www.alfonsadistribuidora.com.ar/database/articulo/fotos/75/CERVEZA%20CORONA%20355%20CC__1.jpg",
      "categoria": "cervezas"
  },
  {
      "id": "4",
      "nombre_producto": "Vodka Absolut",
      "tipo": "alcohólicas",
      "volumen": "1L",
      "valor": 8000,
      "cantidad": 75,
      "promocion": "20% en segunda unidad",
      "image": "https://acdn.mitiendanube.com/stores/001/211/660/products/absolut-ok1-ee7230193fefdcc9c316517724474691-480-0.webp",
      "categoria": "vodka"
  },
  {
      "id": "5",
      "nombre_producto": "Ron Havana Club 7 Años",
      "tipo": "alcohólicas",
      "volumen": "750ml",
      "valor": 5500,
      "cantidad": 60,
      "promocion": "15% descuento en compra de 3 o más",
      "image": "https://labebidadetusfiestas.com.ar/44974-large_default/ron-havana-club-anejo-7-anos-700cc.jpg",
      "categoria": "ron"
  },
  {
      "id": "6",
      "nombre_producto": "Fernet Branca",
      "tipo": "alcohólicas",
      "volumen": "1L",
      "valor": 4500,
      "cantidad": 80,
      "promocion": "10% off en compra de 2 o más",
      "image": "https://borrachines.com.ar/wp-content/uploads/2022/11/FERNET-BRANCA-750ML-MERCADO-LIBRE-2.png",
      "categoria": "aperitivos"
  },
  {
      "id": "7",
      "nombre_producto": "Whisky Jack Daniel's",
      "tipo": "alcohólicas",
      "volumen": "700ml",
      "valor": 11000,
      "cantidad": 40,
      "promocion": "5% en compra de 2 o más",
      "image": "https://acdn.mitiendanube.com/stores/001/211/660/products/jack-daniels-old-071-1e1cb312375b325f5716063985425824-640-0.jpg",
      "categoria": "whiskys"
  },
  {
      "id": "8",
      "nombre_producto": "Vino Cabernet Sauvignon Norton",
      "tipo": "alcohólicas",
      "volumen": "750ml",
      "valor": 5000,
      "cantidad": 150,
      "promocion": "10% en segunda unidad",
      "image": "https://www.espaciovino.com.ar/media/default/0001/56/thumb_55518_default_big.jpeg",
      "categoria": "vinos"
  },
  {
      "id": "9",
      "nombre_producto": "Cerveza Heineken",
      "tipo": "alcohólicas",
      "volumen": "473ml",
      "valor": 300,
      "cantidad": 400,
      "promocion": "Compra 6 y paga 5",
      "image": "https://jumboargentina.vtexassets.com/arquivos/ids/790164-800-auto?v=638271489783770000&width=800&height=auto&aspect=true",
      "categoria": "cervezas"
  },
  {
      "id": "10",
      "nombre_producto": "Vodka Smirnoff",
      "tipo": "alcohólicas",
      "volumen": "1L",
      "valor": 7000,
      "cantidad": 90,
      "promocion": "Compra 3 y paga 2",
      "image": "https://www.craftmoments.com.ar/wp-content/uploads/2022/12/smf_21_685x1200.jpg",
      "categoria": "vodka"
  },
  {
      "id": "11",
      "nombre_producto": "Ron Bacardí Añejo",
      "tipo": "alcohólicas",
      "volumen": "750ml",
      "valor": 6000,
      "cantidad": 80,
      "promocion": "10% en compra de 2 o más",
      "image": "https://tiendaoficial.bacardi.com/cdn/shop/files/FY22_Mx_Bacardi_Anejo_Local_Productshot_3000x3000_aa17000b-611a-4067-8b36-64172883d339.png?v=1694657205",
      "categoria": "ron"
  },
  {
      "id": "12",
      "nombre_producto": "Gancia Americano",
      "tipo": "alcohólicas",
      "volumen": "950ml",
      "valor": 2000,
      "cantidad": 90,
      "promocion": "10% en segunda unidad",
      "image": "https://acdn.mitiendanube.com/stores/001/998/430/products/gancia-mayorista-en-tu-casa1-2c7f7fef83bf4087ce16667204744332-1024-1024.jpg",
      "categoria": "aperitivos"
  },
  {
      "id": "13",
      "nombre_producto": "Whisky Glenfiddich 12 Años",
      "tipo": "alcohólicas",
      "volumen": "700ml",
      "valor": 13000,
      "cantidad": 25,
      "promocion": "5% en compra de 2 o más",
      "image": "https://shop.norton.com.ar/cdn/shop/files/Glenfiddich_12YO-estuche_1000x1000_9a53b89b-5d21-4e1b-85ff-a67d795e3ed9_2048x2048_crop_center@2x.png?v=1692977483",
      "categoria": "whiskys"
  },
  {
      "id": "14",
      "nombre_producto": "Vino Syrah Trapiche",
      "tipo": "alcohólicas",
      "volumen": "750ml",
      "valor": 4500,
      "cantidad": 180,
      "promocion": "10% en segunda unidad",
      "image": "https://www.vinosyspirits.com/media/catalog/product/7/4/74147_-_fdc_syrah_1370_x_2400.jpg?optimize=low&bg-color=255,255,255&fit=bounds&height=&width=&canvas=:",
      "categoria": "vinos"
  },
  {
      "id": "15",
      "nombre_producto": "Cerveza Stella Artois",
      "tipo": "alcohólicas",
      "volumen": "1L",
      "valor": 500,
      "cantidad": 200,
      "promocion": "Compra 4 y paga 3",
      "image": "https://www.espaciovino.com.ar/media/default/0001/64/thumb_63958_default_big.jpeg",
      "categoria": "cervezas"
  },
  {
      "id": "16",
      "nombre_producto": "Vodka Grey Goose",
      "tipo": "alcohólicas",
      "volumen": "750ml",
      "valor": 9000,
      "cantidad": 65,
      "promocion": "5% en compra de 3 o más",
      "image": "https://http2.mlstatic.com/D_NQ_NP_2X_902755-MLA53192423609_012023-F.webp",
      "categoria": "vodka"
  },
  {
      "id": "17",
      "nombre_producto": "Ron Mount Gay",
      "tipo": "alcohólicas",
      "volumen": "700ml",
      "valor": 8500,
      "cantidad": 50,
      "promocion": "10% en compra de 2 o más",
      "image": "https://whiskypedia.com.ar/wp-content/uploads/2024/08/Mount-Gay_Eclipse_Rum-final.jpg.webp",
      "categoria": "ron"
  },
  {
      "id": "18",
      "nombre_producto": "Cynar",
      "tipo": "alcohólicas",
      "volumen": "750ml",
      "valor": 2500,
      "cantidad": 100,
      "promocion": "10% en segunda unidad",
      "image": "https://www.espaciovino.com.ar/media/default/0001/58/thumb_57783_default_big.jpeg",
      "categoria": "aperitivos"
  },
  {
      "id": "19",
      "nombre_producto": "Coca-Cola",
      "tipo": "gaseosas",
      "volumen": "2L",
      "valor": 250,
      "cantidad": 200,
      "promocion": "Compra 4 y paga 3",
      "image": "https://jumboargentina.vtexassets.com/arquivos/ids/782825/Gaseosa-Coca-cola-Sabor-Original-2-25-L-2-247191.jpg?v=638206689776800000",
      "categoria": "gaseosas"
  },
  {
      "id": "20",
      "nombre_producto": "Sprite",
      "tipo": "gaseosas",
      "volumen": "2L",
      "valor": 230,
      "cantidad": 150,
      "promocion": "Compra 3 y paga 2",
      "categoria": "gaseosas",
      "image": "https://carrefourar.vtexassets.com/arquivos/ids/368783/7790895001000_E02.jpg?v=638290817054030000"
  },
  {
      "id": "21",
      "nombre_producto": "Fanta Naranja",
      "tipo": "gaseosas",
      "volumen": "2L",
      "valor": 220,
      "cantidad": 180,
      "promocion": "Compra 5 y paga 4",
      "categoria": "gaseosas",
      "image": "https://modomarketar.vteximg.com.br/arquivos/ids/156440/Fanta-Zero-Naranja-X-2-25-Lt-1-2796.jpg?v=637813033177200000"
  }
]
	</script>

	<script>
		const cuentaCarritoElement = document.getElementById("cuenta-carrito");

/** Toma un objeto producto o un objeto con al menos un ID y lo agrega al carrito */
function agregarAlCarrito(producto){
  //Revisa si el producto está en el carrito.
  let memoria = JSON.parse(localStorage.getItem("bebidas"));
  let cantidadProductoFinal;
  //Si no hay localstorage se crea
  if(!memoria || memoria.length === 0) {
    const nuevoProducto = getNuevoProductoParaMemoria(producto)
    localStorage.setItem("bebidas",JSON.stringify([nuevoProducto]));
    actualizarNumeroCarrito();
    cantidadProductoFinal = 1;
  }
  else {
    //Ver si el producto esta en el LocalStorage
    const indiceProducto = memoria.findIndex(bebida => bebida.id === producto.id)
    const nuevaMemoria = memoria;
    //Si el producto no está en el carrito, se agrega
    if(indiceProducto === -1){
      const nuevoProducto = getNuevoProductoParaMemoria(producto);
      nuevaMemoria.push(nuevoProducto);
      cantidadProductoFinal = 1;
    } else {
      //Si el producto YA está en el carrito le agrego 1 a la cantidad.
      nuevaMemoria[indiceProducto].cantidad ++;
      cantidadProductoFinal = nuevaMemoria[indiceProducto].cantidad;
    }
    localStorage.setItem("bebidas",JSON.stringify(nuevaMemoria));
    actualizarNumeroCarrito();
    return cantidadProductoFinal;
  }
}

/** Resta una unidad de un producto del carrito */
function restarAlCarrito(producto){
  let memoria = JSON.parse(localStorage.getItem("bebidas"));
  let cantidadProductoFinal = 0;
  const indiceProducto = memoria.findIndex(bebida => bebida.id === producto.id)
  let nuevaMemoria = memoria;
  nuevaMemoria[indiceProducto].cantidad--;
  cantidadProductoFinal = nuevaMemoria[indiceProducto].cantidad;
  if(cantidadProductoFinal === 0){
    nuevaMemoria.splice(indiceProducto,1)
  };
  localStorage.setItem("bebidas",JSON.stringify(nuevaMemoria));
  actualizarNumeroCarrito();
  return cantidadProductoFinal;
}

/*
function eliminarItemCarrito(event){
  let memoria = JSON.parse(localStorage.getItem("bebidas"));
  const indiceProducto = memoria.findIndex(bebida => bebida.id === producto.id);
  const buttonClicked = event.target;

  memoria.remove();
}
*/

/** Agrega cantidad a un objeto producto */
function getNuevoProductoParaMemoria(producto){
  const nuevoProducto = producto;
  nuevoProducto.cantidad = 1;
  return nuevoProducto;
}

/** Actualiza el número del carrito del header */
function actualizarNumeroCarrito(){
  let cuenta = 0;
  const memoria = JSON.parse(localStorage.getItem("bebidas"));
  if(memoria && memoria.length > 0){
    cuenta = memoria.reduce((acum, current)=>acum+current.cantidad,0)
    return cuentaCarritoElement.innerText = cuenta;
  }
  cuentaCarritoElement.innerText = 0;
}

/** Reinicia el carrito */
function reiniciarCarrito(){
  localStorage.removeItem("bebidas");
  actualizarNumeroCarrito();
}

/** Finaliza la compra y guarda el historial */
/** Evento de clic en el botón de finalizar compra */
document.getElementById("boton-pagar").addEventListener("click", finalizarCompra);
function finalizarCompra() {
  // Obtener el carrito actual desde localStorage
  const carritoActual = JSON.parse(localStorage.getItem("bebidas")) || [];

  // Si el carrito está vacío, no se realiza ninguna acción
  if (carritoActual.length === 0) {
    alert("El carrito está vacío.");
    return;
  }

  // Obtener el historial actual del localStorage
  let historial = JSON.parse(localStorage.getItem("historial")) || [];

  // Agregar los productos del carrito al historial con la fecha de compra
  const nuevaCompra = {
    fecha: new Date().toLocaleString(),
    productos: carritoActual
  };
  historial.push(nuevaCompra);

  // Guardar el historial actualizado en localStorage
  localStorage.setItem("historial", JSON.stringify(historial));

  // Vaciar el carrito y actualizar la cuenta
  reiniciarCarrito();

  alert("Compra realizada exitosamente y guardada en el historial.");
}



actualizarNumeroCarrito();
	</script>

<script>
const contenedorTarjetas = document.getElementById("cart-container");
const cantidadElement = document.getElementById("cantidad");
const precioElement = document.getElementById("precio");
const carritoVacioElement = document.getElementById("carrito-vacio");
const totalesContainer = document.getElementById("totales");

/** Crea las tarjetas de productos teniendo en cuenta lo guardado en localstorage */
function crearTarjetasProductosCarrito() {
  contenedorTarjetas.innerHTML = "";
  const productos = JSON.parse(localStorage.getItem("bebidas"));
  if (productos && productos.length > 0) {
    productos.forEach((producto) => {
      const nuevaBebida = document.createElement("div");
      nuevaBebida.classList = "tarjeta-producto";
      nuevaBebida.innerHTML = `
    <div class = "cambiar-Cantidad">
      <button>-</button>
      <span class="cantidad">${producto.cantidad}</span>
      <button>+</button>
    </div>
    <img src="${producto.image}" alt="bebida 1">
    <h3>${producto.nombre_producto}</h3>
    <div class = "precio-Eliminar">
      <span>$${producto.valor}</span>
      <button class = "boton-Eliminar">Eliminar</button>
    </div>
    `;
      contenedorTarjetas.appendChild(nuevaBebida);
      nuevaBebida
        .getElementsByTagName("button")[0]
        .addEventListener("click", (e) => {
          const cantidadElement = e.target.parentElement.getElementsByClassName("cantidad")[0];
          cantidadElement.innerText = restarAlCarrito(producto);
          crearTarjetasProductosCarrito();
          actualizarTotales();
        });
      nuevaBebida
        .getElementsByTagName("button")[1]
        .addEventListener("click", (e) => {
          const cantidadElement = e.target.parentElement.getElementsByClassName("cantidad")[0];
          cantidadElement.innerText = agregarAlCarrito(producto);
          actualizarTotales();
        });
    });
  }
  revisarMensajeVacio();
  actualizarTotales();
  actualizarNumeroCarrito();
}

crearTarjetasProductosCarrito();

/** Actualiza el total de precio y unidades de la página del carrito */
function actualizarTotales() {
  const productos = JSON.parse(localStorage.getItem("bebidas"));
  let cantidad = 0;
  let precio = 0;
  if (productos && productos.length > 0) {
    productos.forEach((producto) => {
      cantidad += producto.cantidad;
      precio += producto.valor * producto.cantidad;
    });
  }
  cantidadElement.innerText = cantidad;
  precioElement.innerText = precio;
  if(precio === 0) {
    reiniciarCarrito();
    revisarMensajeVacio();
  }
}

document.getElementById("reiniciar").addEventListener("click", () => {
  contenedorTarjetas.innerHTML = "";
  reiniciarCarrito();
  revisarMensajeVacio();
});

/** Muestra o esconde el mensaje de que no hay nada en el carrito */
function revisarMensajeVacio() {
  const productos = JSON.parse(localStorage.getItem("bebidas"));
  carritoVacioElement.classList.toggle("escondido", productos);
  totalesContainer.classList.toggle("escondido", !productos);
}

</script>

</body>
</html>